<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule I - Laboratorio de Mezclas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        body {
            background: #0a0a0f;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(63, 94, 251, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(252, 70, 107, 0.05) 0%, transparent 50%);
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .glass-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255,255,255,0.15);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .neon-text {
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.5), 0 0 40px rgba(99, 102, 241, 0.3);
        }
        .neon-border {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3), inset 0 0 20px rgba(99, 102, 241, 0.1);
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .ingredient-tag {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
            transition: all 0.2s ease;
        }
        .ingredient-tag:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.4) 0%, rgba(168, 85, 247, 0.4) 100%);
            transform: scale(1.05);
        }
        .effect-badge {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }
        .negative-effect {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        .neutral-effect {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }
        .tab-active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(168, 85, 247, 0.3) 100%);
            border: 1px solid rgba(99, 102, 241, 0.5);
            color: white;
        }
        .tab-inactive {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.5);
        }
        .tab-inactive:hover {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
        }
        .mixing-slot {
            background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 100%);
            border: 2px dashed rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        .mixing-slot.filled {
            border-color: rgba(99, 102, 241, 0.5);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
        }
        .scroll-hide::-webkit-scrollbar {
            display: none;
        }
        .scroll-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        .progress-bar {
            background: linear-gradient(90deg, #6366f1 0%, #a855f7 100%);
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            height: 6px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        .glow-icon {
            filter: drop-shadow(0 0 8px currentColor);
        }
        /* Chart container fix */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
    </style>
<base target="_blank">
</head>
<body class="text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="fixed top-0 w-full z-50 glass border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center animate-pulse-slow">
                        <i class="fas fa-flask text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold gradient-text">Schedule I Lab</h1>
                        <p class="text-xs text-gray-400">Calculadora de Mezclas Profesional</p>
                    </div>
                </div>
                <nav class="hidden md:flex items-center gap-2">
                    <button onclick="showSection('calculator')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all tab-active" id="nav-calculator">
                        <i class="fas fa-calculator mr-2"></i>Calculadora
                    </button>
                    <button onclick="showSection('ingredients')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all tab-inactive" id="nav-ingredients">
                        <i class="fas fa-vials mr-2"></i>Ingredientes
                    </button>
                    <button onclick="showSection('recipes')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all tab-inactive" id="nav-recipes">
                        <i class="fas fa-book mr-2"></i>Recetas
                    </button>
                    <button onclick="showSection('analytics')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all tab-inactive" id="nav-analytics">
                        <i class="fas fa-chart-line mr-2"></i>An√°lisis
                    </button>
                </nav>
                <div class="flex items-center gap-3">
                    <div class="glass px-3 py-1 rounded-full text-xs mono text-gray-400">
                        <i class="fas fa-coins mr-1 text-yellow-400"></i>
                        <span id="total-profit">$0</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-20 pb-8 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">

        <!-- Calculator Section -->
        <section id="section-calculator" class="space-y-6">
            <!-- Hero Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="glass-card rounded-2xl p-5 animate-float" style="animation-delay: 0s;">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Costo Total</span>
                        <i class="fas fa-dollar-sign text-red-400 glow-icon"></i>
                    </div>
                    <div class="text-2xl font-bold mono" id="stat-cost">$0.00</div>
                    <div class="text-xs text-gray-500 mt-1">Inversi√≥n en ingredientes</div>
                </div>
                <div class="glass-card rounded-2xl p-5 animate-float" style="animation-delay: 0.2s;">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Precio Venta</span>
                        <i class="fas fa-tags text-green-400 glow-icon"></i>
                    </div>
                    <div class="text-2xl font-bold mono text-green-400" id="stat-sell">$0.00</div>
                    <div class="text-xs text-gray-500 mt-1">Precio de mercado</div>
                </div>
                <div class="glass-card rounded-2xl p-5 animate-float" style="animation-delay: 0.4s;">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Ganancia Neta</span>
                        <i class="fas fa-chart-line text-indigo-400 glow-icon"></i>
                    </div>
                    <div class="text-2xl font-bold mono gradient-text" id="stat-profit">$0.00</div>
                    <div class="text-xs text-gray-500 mt-1">ROI: <span id="stat-roi">0%</span></div>
                </div>
                <div class="glass-card rounded-2xl p-5 animate-float" style="animation-delay: 0.6s;">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Adicci√≥n</span>
                        <i class="fas fa-fire text-orange-400 glow-icon"></i>
                    </div>
                    <div class="text-2xl font-bold mono text-orange-400" id="stat-addiction">0%</div>
                    <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                        <div class="progress-bar h-2 rounded-full transition-all" id="addiction-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Base Drug Selection -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-cannabis text-green-400"></i>
                        Producto Base
                    </h3>
                    <div class="space-y-3" id="base-drugs">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Mixing Station -->
                <div class="glass-card rounded-2xl p-6 lg:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-flask text-indigo-400"></i>
                            Estaci√≥n de Mezcla
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="undoLastIngredient()" class="px-3 py-1.5 rounded-lg glass text-xs hover:bg-white/10 transition">
                                <i class="fas fa-undo mr-1"></i>Deshacer
                            </button>
                            <button onclick="clearMix()" class="px-3 py-1.5 rounded-lg glass text-xs hover:bg-red-500/20 text-red-400 transition">
                                <i class="fas fa-trash mr-1"></i>Limpiar
                            </button>
                        </div>
                    </div>

                    <!-- Mixing Slots -->
                    <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 mb-4" id="mixing-slots">
                        <!-- Slots generated by JS -->
                    </div>

                    <!-- Ingredients Grid -->
                    <div class="mt-6">
                        <h4 class="text-sm font-medium text-gray-400 mb-3">Ingredientes Disponibles</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-2 max-h-64 overflow-y-auto scroll-hide" id="ingredients-grid">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Effects Display -->
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-magic text-purple-400"></i>
                    Efectos Generados
                </h3>
                <div id="effects-container" class="flex flex-wrap gap-2">
                    <span class="text-gray-500 italic">Agrega ingredientes para ver los efectos...</span>
                </div>
            </div>

            <!-- Save Recipe -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center gap-4">
                    <input type="text" id="recipe-name" placeholder="Nombre de tu receta..." 
                           class="flex-1 bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition">
                    <button onclick="saveCurrentRecipe()" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl font-medium hover:shadow-lg hover:shadow-indigo-500/25 transition-all">
                        <i class="fas fa-save mr-2"></i>Guardar Receta
                    </button>
                </div>
            </div>
        </section>

        <!-- Ingredients Section -->
        <section id="section-ingredients" class="hidden space-y-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-2xl font-bold mb-6 gradient-text">Base de Datos de Ingredientes</h2>

                <!-- Filters -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button onclick="filterIngredients('all')" class="px-4 py-2 rounded-full text-sm bg-indigo-600 text-white">Todos</button>
                    <button onclick="filterIngredients('early')" class="px-4 py-2 rounded-full text-sm glass hover:bg-white/10">Early Game</button>
                    <button onclick="filterIngredients('mid')" class="px-4 py-2 rounded-full text-sm glass hover:bg-white/10">Mid Game</button>
                    <button onclick="filterIngredients('late')" class="px-4 py-2 rounded-full text-sm glass hover:bg-white/10">Late Game</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="ingredients-list">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Effects Reference -->
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4">Referencia de Efectos</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="text-left py-3 px-4">Efecto</th>
                                <th class="text-left py-3 px-4">Tipo</th>
                                <th class="text-left py-3 px-4">Multiplicador</th>
                                <th class="text-left py-3 px-4">Descripci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="effects-table">
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Recipes Section -->
        <section id="section-recipes" class="hidden space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold gradient-text">Recetas Guardadas</h2>
                <button onclick="loadDefaultRecipes()" class="px-4 py-2 glass rounded-lg text-sm hover:bg-white/10">
                    <i class="fas fa-download mr-2"></i>Cargar Recetas Optimizadas
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="saved-recipes">
                <!-- Generated by JS -->
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="section-analytics" class="hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Profit Chart -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4">Rentabilidad por Tipo</h3>
                    <div class="chart-container">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>

                <!-- Addiction vs Price -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4">Adicci√≥n vs Precio</h3>
                    <div class="chart-container">
                        <canvas id="scatterChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4">Optimizador de Mezclas</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <select id="opt-base" class="bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-sm">
                        <option value="">Seleccionar Base...</option>
                    </select>
                    <select id="opt-strategy" class="bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-sm">
                        <option value="profit">M√°xima Ganancia</option>
                        <option value="addiction">M√°xima Adicci√≥n</option>
                        <option value="balanced">Balanceado</option>
                    </select>
                    <button onclick="optimizeMix()" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl font-medium">
                        <i class="fas fa-calculator mr-2"></i>Calcular √ìptimo
                    </button>
                </div>
                <div id="optimization-result" class="hidden">
                    <!-- Result will appear here -->
                </div>
            </div>
        </section>
    </main>

    <script>
        // Game Data
        const baseDrugs = {
            'og-kush': { name: 'OG Kush', basePrice: 38, baseCost: 30, addiction: 0, effect: 'Calming' },
            'sour-diesel': { name: 'Sour Diesel', basePrice: 40, baseCost: 35, addiction: 10, effect: 'Refreshing' },
            'green-crack': { name: 'Green Crack', basePrice: 43, baseCost: 40, addiction: 34, effect: 'Energizing' },
            'grandaddy-purple': { name: 'Grandaddy Purple', basePrice: 45, baseCost: 45, addiction: 0, effect: 'Sedating' },
            'meth': { name: 'Methamphetamine', basePrice: 70, baseCost: 80, addiction: 60, effect: null },
            'shrooms': { name: 'Shrooms', basePrice: 65, baseCost: 140, addiction: 5, effect: null },
            'cocaine': { name: 'Cocaine', basePrice: 150, baseCost: 150, addiction: 40, effect: null }
        };

        const ingredients = {
            'cuke': { name: 'Cuke', price: 2, effect: 'Energizing', unlock: 'Immediately', icon: 'ü•í' },
            'banana': { name: 'Banana', price: 2, effect: 'Gingeritis', unlock: 'Immediately', icon: 'üçå' },
            'paracetamol': { name: 'Paracetamol', price: 3, effect: 'Sneaky', unlock: 'Immediately', icon: 'üíä' },
            'donut': { name: 'Donut', price: 3, effect: 'Calorie-Dense', unlock: 'Immediately', icon: 'üç©' },
            'viagra': { name: 'Viagra', price: 4, effect: 'Tropic Thunder', unlock: 'Hoodlum II', icon: 'üíô' },
            'mouth-wash': { name: 'Mouth Wash', price: 4, effect: 'Balding', unlock: 'Hoodlum III', icon: 'üß¥' },
            'flu-medicine': { name: 'Flu Medicine', price: 5, effect: 'Sedating', unlock: 'Hoodlum IV', icon: 'ü§ß' },
            'gasoline': { name: 'Gasoline', price: 5, effect: 'Toxic', unlock: 'Hoodlum V', icon: '‚õΩ' },
            'energy-drink': { name: 'Energy Drink', price: 6, effect: 'Athletic', unlock: 'Peddler I', icon: 'ü•§' },
            'motor-oil': { name: 'Motor Oil', price: 6, effect: 'Slippery', unlock: 'Peddler II', icon: 'üõ¢Ô∏è' },
            'mega-bean': { name: 'Mega Bean', price: 7, effect: 'Foggy', unlock: 'Peddler II', icon: 'ü´ò' },
            'chili': { name: 'Chili', price: 7, effect: 'Spicy', unlock: 'Peddler IV', icon: 'üå∂Ô∏è' },
            'battery': { name: 'Battery', price: 8, effect: 'Bright-Eyed', unlock: 'Peddler V', icon: 'üîã' },
            'iodine': { name: 'Iodine', price: 8, effect: 'Jennerising', unlock: 'Hustler I', icon: 'üß™' },
            'addy': { name: 'Addy', price: 9, effect: 'Thought-Provoking', unlock: 'Hustler II', icon: 'üíâ' },
            'horse-semen': { name: 'Horse Semen', price: 9, effect: 'Long Faced', unlock: 'Hustler III', icon: 'üê¥' }
        };

        // Effect multipliers
        const effectMultipliers = {
            'Anti-Gravity': 0.5, 'Athletic': 0.4, 'Balding': 0.3, 'Bright-Eyed': 0.4,
            'Calming': 0.2, 'Calorie-Dense': 0.2, 'Cyclopean': 0.5, 'Disorienting': 0.3,
            'Electrifying': 0.5, 'Energizing': 0.3, 'Euphoric': 0.4, 'Explosive': 0.6,
            'Focused': 0.3, 'Foggy': 0.2, 'Gingeritis': 0.2, 'Glowing': 0.4,
            'Jennerising': 0.4, 'Laxative': 0.1, 'Long Faced': 0.4, 'Munchies': 0.2,
            'Paranoia': 0.1, 'Refreshing': 0.2, 'Schizophrenic': 0.3, 'Sedating': 0.3,
            'Seizure-Inducing': 0.1, 'Shrinking': 0.4, 'Slippery': 0.2, 'Smelly': 0.1,
            'Sneaky': 0.3, 'Spicy': 0.3, 'Thought-Provoking': 0.4, 'Toxic': 0.1,
            'Tropic Thunder': 0.5, 'Zombifying': 0.6
        };

        // State
        let currentMix = {
            base: null,
            ingredients: []
        };
        let savedRecipes = JSON.parse(localStorage.getItem('schedule1_recipes') || '[]');
        let charts = {}; // Store chart instances
        let chartsInitialized = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderBaseDrugs();
            renderIngredientsGrid();
            renderIngredientsList();
            renderEffectsTable();
            renderSavedRecipes();
            populateOptimizerSelect();
            updateMixingSlots();
        });

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');

            // Update nav
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            document.getElementById(`nav-${section}`).classList.remove('tab-inactive');
            document.getElementById(`nav-${section}`).classList.add('tab-active');

            // Initialize charts only when showing analytics and only once
            if (section === 'analytics' && !chartsInitialized) {
                initCharts();
                chartsInitialized = true;
            }
        }

        function renderBaseDrugs() {
            const container = document.getElementById('base-drugs');
            container.innerHTML = Object.entries(baseDrugs).map(([key, drug]) => `
                <div onclick="selectBase('${key}')" 
                     class="cursor-pointer p-4 rounded-xl border-2 transition-all ${currentMix.base === key ? 'border-indigo-500 bg-indigo-500/20' : 'border-white/10 hover:border-white/30 bg-white/5'}">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-semibold">${drug.name}</div>
                            <div class="text-xs text-gray-400">Base: $${drug.baseCost} ‚Üí Venta: $${drug.basePrice}</div>
                        </div>
                        ${drug.effect ? `<span class="text-xs effect-badge px-2 py-1 rounded">${drug.effect}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function selectBase(key) {
            currentMix.base = key;
            currentMix.ingredients = [];
            renderBaseDrugs();
            updateMixingSlots();
            calculateMix();
        }

        function renderIngredientsGrid() {
            const container = document.getElementById('ingredients-grid');
            container.innerHTML = Object.entries(ingredients).map(([key, ing]) => `
                <button onclick="addIngredient('${key}')" 
                        class="ingredient-tag p-3 rounded-xl text-left hover:scale-105 transition-all">
                    <div class="text-2xl mb-1">${ing.icon}</div>
                    <div class="text-xs font-medium">${ing.name}</div>
                    <div class="text-xs text-gray-400">$${ing.price}</div>
                </button>
            `).join('');
        }

        function addIngredient(key) {
            if (!currentMix.base) {
                alert('Selecciona un producto base primero');
                return;
            }
            if (currentMix.ingredients.length >= 8) {
                alert('M√°ximo 8 ingredientes');
                return;
            }
            currentMix.ingredients.push(key);
            updateMixingSlots();
            calculateMix();
        }

        function undoLastIngredient() {
            currentMix.ingredients.pop();
            updateMixingSlots();
            calculateMix();
        }

        function clearMix() {
            currentMix.ingredients = [];
            updateMixingSlots();
            calculateMix();
        }

        function updateMixingSlots() {
            const container = document.getElementById('mixing-slots');
            let html = '';
            for (let i = 0; i < 8; i++) {
                if (i < currentMix.ingredients.length) {
                    const ing = ingredients[currentMix.ingredients[i]];
                    html += `
                        <div class="mixing-slot filled rounded-xl p-3 aspect-square flex flex-col items-center justify-center cursor-pointer" onclick="removeIngredient(${i})">
                            <div class="text-2xl">${ing.icon}</div>
                            <div class="text-xs mt-1 text-center">${ing.name}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="mixing-slot rounded-xl p-3 aspect-square flex items-center justify-center">
                            <span class="text-gray-600 text-xs">${i + 1}</span>
                        </div>
                    `;
                }
            }
            container.innerHTML = html;
        }

        function removeIngredient(index) {
            currentMix.ingredients.splice(index, 1);
            updateMixingSlots();
            calculateMix();
        }

        function calculateMix() {
            if (!currentMix.base) {
                resetStats();
                return;
            }

            const base = baseDrugs[currentMix.base];
            let totalCost = base.baseCost;
            let effects = base.effect ? [base.effect] : [];

            currentMix.ingredients.forEach(key => {
                const ing = ingredients[key];
                totalCost += ing.price;

                if (!effects.includes(ing.effect)) {
                    effects.push(ing.effect);
                }
            });

            let multiplier = 1;
            effects.forEach(effect => {
                if (effectMultipliers[effect]) {
                    multiplier += effectMultipliers[effect];
                }
            });

            const sellPrice = Math.round(base.basePrice * multiplier);
            const profit = sellPrice - totalCost;
            const roi = ((profit / totalCost) * 100).toFixed(1);
            const addiction = Math.min(100, base.addiction + (effects.length * 8));

            document.getElementById('stat-cost').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('stat-sell').textContent = `$${sellPrice.toFixed(2)}`;
            document.getElementById('stat-profit').textContent = `$${profit.toFixed(2)}`;
            document.getElementById('stat-roi').textContent = `${roi}%`;
            document.getElementById('stat-addiction').textContent = `${addiction}%`;
            document.getElementById('addiction-bar').style.width = `${addiction}%`;
            document.getElementById('total-profit').textContent = `$${profit}`;

            const effectsContainer = document.getElementById('effects-container');
            if (effects.length === 0) {
                effectsContainer.innerHTML = '<span class="text-gray-500 italic">Sin efectos especiales</span>';
            } else {
                effectsContainer.innerHTML = effects.map(effect => {
                    const isNegative = ['Toxic', 'Paranoia', 'Seizure-Inducing', 'Smelly', 'Laxative', 'Disorienting'].includes(effect);
                    const isNeutral = ['Calming', 'Sedating', 'Foggy'].includes(effect);
                    const className = isNegative ? 'negative-effect' : isNeutral ? 'neutral-effect' : 'effect-badge';
                    return `<span class="${className} px-3 py-1.5 rounded-full text-sm font-medium">${effect}</span>`;
                }).join('');
            }
        }

        function resetStats() {
            document.getElementById('stat-cost').textContent = '$0.00';
            document.getElementById('stat-sell').textContent = '$0.00';
            document.getElementById('stat-profit').textContent = '$0.00';
            document.getElementById('stat-roi').textContent = '0%';
            document.getElementById('stat-addiction').textContent = '0%';
            document.getElementById('addiction-bar').style.width = '0%';
            document.getElementById('effects-container').innerHTML = '<span class="text-gray-500 italic">Selecciona un producto base...</span>';
        }

        function saveCurrentRecipe() {
            const name = document.getElementById('recipe-name').value;
            if (!name) {
                alert('Ingresa un nombre para la receta');
                return;
            }
            if (!currentMix.base) {
                alert('Crea una mezcla primero');
                return;
            }

            const recipe = {
                id: Date.now(),
                name: name,
                base: currentMix.base,
                ingredients: [...currentMix.ingredients],
                date: new Date().toLocaleDateString()
            };

            savedRecipes.push(recipe);
            localStorage.setItem('schedule1_recipes', JSON.stringify(savedRecipes));
            renderSavedRecipes();
            document.getElementById('recipe-name').value = '';
            alert('Receta guardada exitosamente');
        }

        function renderSavedRecipes() {
            const container = document.getElementById('saved-recipes');
            if (savedRecipes.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-book-open text-4xl mb-4 opacity-30"></i>
                        <p>No tienes recetas guardadas</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = savedRecipes.map(recipe => {
                const base = baseDrugs[recipe.base];
                const totalCost = base.baseCost + recipe.ingredients.reduce((sum, key) => sum + ingredients[key].price, 0);
                return `
                    <div class="glass-card rounded-2xl p-5">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-semibold text-lg">${recipe.name}</h4>
                                <p class="text-xs text-gray-400">${base.name} ‚Ä¢ ${recipe.date}</p>
                            </div>
                            <button onclick="deleteRecipe(${recipe.id})" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${recipe.ingredients.map(key => `
                                <span class="text-xs bg-white/10 px-2 py-1 rounded">${ingredients[key].icon} ${ingredients[key].name}</span>
                            `).join('')}
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">Costo: $${totalCost}</span>
                            <button onclick="loadRecipe(${recipe.id})" class="text-indigo-400 hover:text-indigo-300 font-medium">
                                Cargar <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadRecipe(id) {
            const recipe = savedRecipes.find(r => r.id === id);
            if (recipe) {
                currentMix.base = recipe.base;
                currentMix.ingredients = [...recipe.ingredients];
                renderBaseDrugs();
                updateMixingSlots();
                calculateMix();
                showSection('calculator');
            }
        }

        function deleteRecipe(id) {
            savedRecipes = savedRecipes.filter(r => r.id !== id);
            localStorage.setItem('schedule1_recipes', JSON.stringify(savedRecipes));
            renderSavedRecipes();
        }

        function renderIngredientsList() {
            const container = document.getElementById('ingredients-list');
            container.innerHTML = Object.entries(ingredients).map(([key, ing]) => `
                <div class="glass-card rounded-xl p-4">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">${ing.icon}</span>
                            <div>
                                <h4 class="font-semibold">${ing.name}</h4>
                                <p class="text-xs text-gray-400">$${ing.price} ‚Ä¢ ${ing.unlock}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="effect-badge px-2 py-1 rounded text-xs">${ing.effect}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderEffectsTable() {
            const tbody = document.getElementById('effects-table');
            tbody.innerHTML = Object.entries(effectMultipliers).map(([effect, multiplier]) => {
                const isNegative = ['Toxic', 'Paranoia', 'Seizure-Inducing', 'Smelly', 'Laxative', 'Disorienting'].includes(effect);
                const type = isNegative ? 'Negativo' : 'Positivo';
                const typeClass = isNegative ? 'text-red-400' : 'text-green-400';
                return `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="py-3 px-4 font-medium">${effect}</td>
                        <td class="py-3 px-4 ${typeClass}">${type}</td>
                        <td class="py-3 px-4 mono">+${(multiplier * 100).toFixed(0)}%</td>
                        <td class="py-3 px-4 text-gray-400 text-xs">Aumenta valor de venta</td>
                    </tr>
                `;
            }).join('');
        }

        function filterIngredients(type) {
            renderIngredientsList();
        }

        function initCharts() {
            // Destroy existing charts if they exist
            if (charts.profit) {
                charts.profit.destroy();
            }
            if (charts.scatter) {
                charts.scatter.destroy();
            }

            // Profit by drug type chart
            const ctx1 = document.getElementById('profitChart').getContext('2d');
            charts.profit = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['OG Kush', 'Sour Diesel', 'Green Crack', 'Grandaddy P', 'Meth', 'Cocaine'],
                    datasets: [{
                        label: 'Ganancia Potencial',
                        data: [45, 50, 55, 60, 250, 600],
                        backgroundColor: 'rgba(99, 102, 241, 0.6)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'rgba(255,255,255,0.7)' }
                        }
                    }
                }
            });

            // Scatter chart
            const ctx2 = document.getElementById('scatterChart').getContext('2d');
            charts.scatter = new Chart(ctx2, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Recetas',
                        data: [
                            {x: 10, y: 40}, {x: 20, y: 70}, {x: 30, y: 120},
                            {x: 40, y: 150}, {x: 50, y: 200}, {x: 60, y: 340},
                            {x: 70, y: 500}, {x: 80, y: 735}
                        ],
                        backgroundColor: 'rgba(168, 85, 247, 0.6)',
                        borderColor: 'rgba(168, 85, 247, 1)',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Adicci√≥n %', color: 'rgba(255,255,255,0.7)' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' }
                        },
                        y: {
                            title: { display: true, text: 'Precio Venta ($)', color: 'rgba(255,255,255,0.7)' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' }
                        }
                    }
                }
            });
        }

        function loadDefaultRecipes() {
            const defaults = [
                {
                    id: 'default-1',
                    name: 'üåø OG Kush Profit Max',
                    base: 'og-kush',
                    ingredients: ['banana', 'paracetamol', 'donut', 'cuke', 'paracetamol', 'banana', 'viagra'],
                    date: 'Predefinida'
                },
                {
                    id: 'default-2',
                    name: '‚ö° Meth God Mix',
                    base: 'meth',
                    ingredients: ['cuke', 'paracetamol', 'banana', 'gasoline', 'cuke', 'battery', 'mega-bean', 'chili'],
                    date: 'Predefinida'
                },
                {
                    id: 'default-3',
                    name: 'üëë Coke Ultimate',
                    base: 'cocaine',
                    ingredients: ['banana', 'cuke', 'paracetamol', 'gasoline', 'cuke', 'battery', 'horse-semen', 'mega-bean'],
                    date: 'Predefinida'
                }
            ];

            savedRecipes = [...defaults, ...savedRecipes.filter(r => !r.id.toString().startsWith('default'))];
            localStorage.setItem('schedule1_recipes', JSON.stringify(savedRecipes));
            renderSavedRecipes();
        }

        function populateOptimizerSelect() {
            const optSelect = document.getElementById('opt-base');
            Object.entries(baseDrugs).forEach(([key, drug]) => {
                optSelect.innerHTML += `<option value="${key}">${drug.name}</option>`;
            });
        }

        function optimizeMix() {
            const base = document.getElementById('opt-base').value;
            const strategy = document.getElementById('opt-strategy').value;

            if (!base) {
                alert('Selecciona una base');
                return;
            }

            const baseData = baseDrugs[base];
            let recommended = [];

            if (strategy === 'profit') {
                recommended = ['viagra', 'battery', 'mega-bean', 'chili', 'paracetamol', 'banana', 'cuke', 'gasoline'];
            } else if (strategy === 'addiction') {
                recommended = ['gasoline', 'motor-oil', 'chili', 'battery', 'addy', 'horse-semen', 'mega-bean', 'energy-drink'];
            } else {
                recommended = ['cuke', 'paracetamol', 'banana', 'viagra', 'battery', 'mega-bean', 'chili', 'donut'];
            }

            const resultDiv = document.getElementById('optimization-result');
            resultDiv.classList.remove('hidden');

            resultDiv.innerHTML = `
                <div class="glass-card rounded-xl p-6 mt-4">
                    <h4 class="font-semibold mb-3">Mezcla Optimizada para ${baseData.name}</h4>
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${recommended.map(key => `
                            <span class="ingredient-tag px-3 py-2 rounded-lg text-sm">
                                ${ingredients[key].icon} ${ingredients[key].name}
                            </span>
                        `).join('')}
                    </div>
                    <button onclick="applyOptimization('${base}', ${JSON.stringify(recommended).replace(/"/g, '&quot;')})" 
                            class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl font-medium hover:shadow-lg transition-all">
                        Aplicar Mezcla
                    </button>
                </div>
            `;
        }

        function applyOptimization(base, recommended) {
            currentMix.base = base;
            currentMix.ingredients = recommended;
            renderBaseDrugs();
            updateMixingSlots();
            calculateMix();
            showSection('calculator');
        }
    </script>
</body>
</html>
